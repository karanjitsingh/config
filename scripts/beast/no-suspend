#!/bin/bash

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
# Will be updated after parsing --user option
INHIBIT_PID_FILE=""

QUIET=0
TARGET_USER=""
STOP_ALL=0

# Must have exactly one command (start/stop)
if [[ "$1" != "start" && "$1" != "stop" && "$1" != "status" ]]; then
    echo "Usage: $(basename "$0") [start|stop|status] [--quiet|-q] [--user <user>] [--all]"
    exit 1
fi

COMMAND="$1"
shift   # remove the command from $@

# Parse options
while [[ $# -gt 0 ]]; do
    case "$1" in
        -q|--quiet)
            QUIET=1
            shift
            ;;
        --user)
            TARGET_USER="$2"
            shift 2
            ;;
        --all)
            STOP_ALL=1
            shift
            ;;
        *)
            echo "Error: unknown option: $1"
            echo "Usage: $(basename "$0") [start|stop|status] [--quiet|-q] [--user <user>] [--all]"
            exit 1
            ;;
    esac
done

# Override SCRIPT_DIR if --user is specified
if [[ -n "$TARGET_USER" ]]; then
    SCRIPT_DIR="/home/$TARGET_USER/scripts/beast"
    if ! sudo test -d "$SCRIPT_DIR"; then
        echo "Error: Directory not found for user '$TARGET_USER': $SCRIPT_DIR"
        exit 1
    fi
fi

# Set PID file path after SCRIPT_DIR is finalized
INHIBIT_PID_FILE="$SCRIPT_DIR/.no-suspend.pid"

log() {
    (( QUIET == 0 )) && echo -e "$@"
}

# Helper to run commands with sudo when TARGET_USER is set
run_cmd() {
    if [[ -n "$TARGET_USER" ]]; then
        sudo "$@"
    else
        "$@"
    fi
}

case "$COMMAND" in
    start)
        # Handle --all: run for all users in /home
        if [[ $STOP_ALL -eq 1 ]]; then
            log "Starting no-suspend for all users..."
            for user in $(sudo ls /home); do
                log "\nRunning no-suspend start for user: $user"
                if [[ $QUIET -eq 1 ]]; then
                    bash "$0" start --user "$user" --quiet || true
                else
                    bash "$0" start --user "$user" || true
                fi
            done
            exit 0
        fi

        # Default: start for current user
        if run_cmd test -f "$INHIBIT_PID_FILE"; then
            INHIBIT_PID=$(run_cmd cat "$INHIBIT_PID_FILE" 2>/dev/null)
            if [ -n "$INHIBIT_PID" ]; then
                # Check if process exists AND matches expected command
                if kill -0 "$INHIBIT_PID" 2>/dev/null; then
                    # Verify it's actually our sleep infinity process
                    CMD=$(ps -p "$INHIBIT_PID" -o cmd= 2>/dev/null | tr -d '\n')
                    if [[ "$CMD" == *"sleep infinity"* ]] || [[ "$CMD" == *"systemd-inhibit"* ]]; then
                        log "Suspend is already blocked. (PID: $INHIBIT_PID)"
                        exit 0
                    else
                        # PID exists but wrong process - stale PID file
                        log "Warning: PID $INHIBIT_PID exists but is not our inhibit process. Cleaning up..."
                        run_cmd rm -f "$INHIBIT_PID_FILE"
                    fi
                else
                    # Process doesn't exist - stale PID file
                    run_cmd rm -f "$INHIBIT_PID_FILE"
                fi
            else
                # Empty or invalid PID file
                run_cmd rm -f "$INHIBIT_PID_FILE"
            fi
        fi

        log "Blocking suspend..."
        INHIBIT_USER="${TARGET_USER:-$USER}"
        systemd-inhibit --what=sleep:idle --who="$INHIBIT_USER" --why="Blocked by no-suspend" sleep infinity &
        PID=$!
        if run_cmd sh -c "echo $PID > '$INHIBIT_PID_FILE'"; then
            log "Done. Suspend is now blocked. (PID: $PID)"
        else
            echo "Error: Failed to write PID file"
            kill "$PID" 2>/dev/null
            exit 1
        fi
        ;;

    stop)
        # Handle --all: run for all users in /home
        if [[ $STOP_ALL -eq 1 ]]; then
            log "Stopping no-suspend for all users..."
            for user in $(sudo ls /home); do
                log "\nRunning no-suspend stop for user: $user"
                if [[ $QUIET -eq 1 ]]; then
                    bash "$0" stop --user "$user" --quiet || true
                else
                    bash "$0" stop --user "$user" || true
                fi
            done
            exit 0
        fi

        # Default: stop for current user (or --user if specified)
        if run_cmd test -f "$INHIBIT_PID_FILE"; then
            log "Restoring suspend..."
            INHIBIT_PID=$(run_cmd cat "$INHIBIT_PID_FILE")
            if run_cmd rm -f "$INHIBIT_PID_FILE"; then
                kill "$INHIBIT_PID" 2>/dev/null
                wait "$INHIBIT_PID" 2>/dev/null || true
                log "Done. Suspend is now enabled."
            else
                echo "Error: Failed to remove PID file"
                exit 1
            fi
        else
            log "Suspend was not blocked with this script."
            exit 1
        fi
        ;;

    status)
        if run_cmd test -f "$INHIBIT_PID_FILE"; then
            INHIBIT_PID=$(run_cmd cat "$INHIBIT_PID_FILE")
            if kill -0 "$INHIBIT_PID" 2>/dev/null; then
                log "Suspend is blocked. (PID: $INHIBIT_PID)"
                log ""
            else
                log "Suspend is not blocked."
                log ""
            fi
        else
            log "Suspend is not blocked."
            log ""
        fi
        systemd-inhibit --list --no-pager
esac
