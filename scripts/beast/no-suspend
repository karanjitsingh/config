#!/bin/bash

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
INHIBIT_PID_FILE="$SCRIPT_DIR/.no-suspend.pid"

QUIET=0

# Must have exactly one command (start/stop)
if [[ "$1" != "start" && "$1" != "stop" && "$1" != "status" ]]; then
    echo "Usage: $(basename "$0") [start|stop|status] [--quiet|-q]"
    exit 1
fi

COMMAND="$1"
shift   # remove the command from $@

# Now only --quiet / -q is allowed (and only once)
while [[ $# -gt 0 ]]; do
    case "$1" in
        -q|--quiet)
            QUIET=1
            shift
            ;;
        *)
            echo "Error: unknown option: $1"
            echo "Usage: $(basename "$0") [start|stop] [--quiet|-q]"
            exit 1
            ;;
    esac
done

log() {
    (( QUIET == 0 )) && echo "$@"
}

case "$COMMAND" in
    start)
        if [ -f "$INHIBIT_PID_FILE" ]; then
            INHIBIT_PID=$(cat "$INHIBIT_PID_FILE" 2>/dev/null)
            if [ -n "$INHIBIT_PID" ]; then
                # Check if process exists AND matches expected command
                if kill -0 "$INHIBIT_PID" 2>/dev/null; then
                    # Verify it's actually our sleep infinity process
                    CMD=$(ps -p "$INHIBIT_PID" -o cmd= 2>/dev/null | tr -d '\n')
                    if [[ "$CMD" == *"sleep infinity"* ]] || [[ "$CMD" == *"systemd-inhibit"* ]]; then
                        log "Suspend is already blocked. (PID: $INHIBIT_PID)"
                        exit 0
                    else
                        # PID exists but wrong process - stale PID file
                        log "Warning: PID $INHIBIT_PID exists but is not our inhibit process. Cleaning up..."
                        rm -f "$INHIBIT_PID_FILE"
                    fi
                else
                    # Process doesn't exist - stale PID file
                    rm -f "$INHIBIT_PID_FILE"
                fi
            else
                # Empty or invalid PID file
                rm -f "$INHIBIT_PID_FILE"
            fi
        fi

        log "Blocking suspend..."
        systemd-inhibit --what=sleep:idle --who="$USER" --why="Blocked by no-suspend" sleep infinity &
        PID=$!
        echo $PID > "$INHIBIT_PID_FILE"
        log "Done. Suspend is now blocked. (PID: $PID)"
        ;;

    stop)
        if [ -f "$INHIBIT_PID_FILE" ]; then
            log "Restoring suspend..."
            INHIBIT_PID=$(cat "$INHIBIT_PID_FILE")
            kill "$INHIBIT_PID" 2>/dev/null
            rm -f "$INHIBIT_PID_FILE"
            wait "$INHIBIT_PID" 2>/dev/null || true
            log "Done. Suspend is now enabled."
        else
            (( QUIET == 0 )) && echo "Suspend was not blocked with this script."
            exit 1
        fi
        ;;

    status)
        if [ -f "$INHIBIT_PID_FILE" ]; then
            INHIBIT_PID=$(cat "$INHIBIT_PID_FILE")
            if kill -0 "$INHIBIT_PID" 2>/dev/null; then
                log "Suspend is blocked. (PID: $INHIBIT_PID)"
                log ""
            else
                log "Suspend is not blocked."
                log ""
            fi
        else
            log "Suspend is not blocked."
            log ""
        fi
        systemd-inhibit --list --no-pager
esac
